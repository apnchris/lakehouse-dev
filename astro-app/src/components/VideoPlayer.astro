---
import { urlFor } from '../utils/image';

interface Props {
  videoPoster?: any;
  videoFile?: any;
  videoCdn?: string;
}

const { videoPoster, videoFile, videoCdn } = Astro.props;

// Determine the video source - prefer CDN, then uploaded file
const videoSrc = videoCdn || (videoFile?.asset?.url);
const posterSrc = videoPoster ? urlFor(videoPoster).width(1920).url() : undefined;

// Generate unique ID for this video player instance
const playerId = `video-${Math.random().toString(36).substr(2, 9)}`;
---

<div class="video-player-wrapper regular-grid">
  <div class="video-player" data-player-id={playerId}>
    {videoSrc && (
      <>
        <video 
          class="video-element"
          poster={posterSrc}
          playsinline
          webkit-playsinline
          preload="metadata"
        >
          <source src={videoSrc} type="video/mp4" />
          Your browser does not support the video tag.
        </video>
        
        <div class="video-controls">
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-filled"></div>
            </div>
          </div>

          <div class="time-display sans uppercase">
            <span class="player-current-time">0:00</span><span class="time-separator">/</span><span class="total-time">0:00</span>
          </div>

          <button class="play-pause-btn" aria-label="Play/Pause">
            <span class="play-icon">Play</span>
            <span class="pause-icon" style="display: none;">Pause</span>
          </button>
          
          <button class="fullscreen-btn" aria-label="Fullscreen">
            Fullscreen
          </button>
        </div>
      </>
    )}
  </div>
</div>

<style>
  .video-player-wrapper {
    margin-bottom: 128px;
  }

  .video-player {
    grid-column: 1 / -1;
    position: relative;
    line-height: 0;
    background: #000;
    display: flex;
    justify-content: space-around;
    align-items: center;
  }

  .video-element {
    width: 100%;
    height: auto;
    display: block;
    cursor: pointer;
  }

  .video-controls {
    width: calc((var(--column) * 4) + (var(--gap) * 3));
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    flex-wrap: wrap;
    column-gap: var(--gap);
    row-gap: 4px;
    margin: var(--gap);
    transition: opacity 0.3s ease;
    color: #FAF7F4;
  }

  .progress-container {
    flex: 1;
    width: 100%;
    cursor: pointer;
    padding: 4px 0;
    grid-column: span 4;
  }

  .progress-bar {
    width: 100%;
    height: 1px;
    border-radius: 1px;
    position: relative;
    overflow: hidden;
  }

  .progress-bar::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 1px;
    background-image: radial-gradient(circle, #FAF7F480 0.5px, rgba(255,255,255,0) 0.5px);
    background-position: 0 center;
    background-size: 3px 1px;
    background-repeat: repeat-x;
    transition: opacity .2s ease;
  }

  .progress-filled {
    height: 100%;
    background: #FAF7F4;
    width: 0%;
    transition: width .3s linear;
  }

  .fullscreen-btn {
    grid-column: span 2;
    margin: 0 0 0 auto;
  }

  @media screen and (max-width: 820px) {
    .video-player-wrapper {
      margin-bottom: 72px;
    }

    .video-controls {
      width: calc(100vw - (var(--gap) * 2));
    }

    .time-display {
      grid-column: span 2;
    }

    .fullscreen-btn {
      grid-column: span 1;
    }
  }
</style>

<script define:vars={{ playerId }}>
  const player = document.querySelector(`[data-player-id="${playerId}"]`);
  if (player) {
    const video = player.querySelector('.video-element');
    const playPauseBtn = player.querySelector('.play-pause-btn');
    const playIcon = player.querySelector('.play-icon');
    const pauseIcon = player.querySelector('.pause-icon');
    const progressContainer = player.querySelector('.progress-container');
    const progressBar = player.querySelector('.progress-bar');
    const progressFilled = player.querySelector('.progress-filled');
    const currentTimeEl = player.querySelector('.player-current-time');
    const totalTimeEl = player.querySelector('.total-time');
    const fullscreenBtn = player.querySelector('.fullscreen-btn');
    const controls = player.querySelector('.video-controls');

    // Format time as M:SS
    function formatTime(seconds) {
      if (isNaN(seconds)) return '0:00';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Toggle play/pause
    function togglePlay() {
      if (video.paused) {
        video.play();
        playIcon.style.display = 'none';
        pauseIcon.style.display = 'block';
      } else {
        video.pause();
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
      }
    }

    // Update progress bar
    function updateProgress() {
      const percent = (video.currentTime / video.duration) * 100;
      progressFilled.style.width = `${percent}%`;
      currentTimeEl.textContent = formatTime(video.currentTime);
    }

    // Seek video
    function seek(e) {
      const rect = progressBar.getBoundingClientRect();
      const pos = (e.clientX - rect.left) / rect.width;
      video.currentTime = pos * video.duration;
    }

    // Toggle fullscreen
    function toggleFullscreen() {
      try {
        // Check if already in fullscreen - if so, just exit
        if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement) {
          exitFullscreen();
          return;
        }

        // If video is paused, play it first then enter fullscreen
        if (video.paused) {
          video.play().then(() => {
            playIcon.style.display = 'none';
            pauseIcon.style.display = 'block';
            // Give it a moment to start playing
            setTimeout(() => enterFullscreen(), 100);
          }).catch(err => {
            console.error('Play error:', err);
          });
        } else {
          // Video is already playing, just enter fullscreen
          enterFullscreen();
        }
      } catch (err) {
        console.error('Fullscreen error:', err);
      }
    }

    function exitFullscreen() {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
      }
    }

    function enterFullscreen() {
      // iOS Safari - use webkit methods
      if (video.webkitEnterFullscreen) {
        video.webkitEnterFullscreen();
        return;
      }
      
      // Standard fullscreen API
      const elementToFullscreen = player;
      
      if (elementToFullscreen.requestFullscreen) {
        elementToFullscreen.requestFullscreen();
      } else if (elementToFullscreen.webkitRequestFullscreen) {
        elementToFullscreen.webkitRequestFullscreen();
      } else if (elementToFullscreen.mozRequestFullScreen) {
        elementToFullscreen.mozRequestFullScreen();
      } else if (elementToFullscreen.msRequestFullscreen) {
        elementToFullscreen.msRequestFullscreen();
      }
    }

    // Event listeners
    playPauseBtn.addEventListener('click', togglePlay);
    video.addEventListener('click', togglePlay);
    video.addEventListener('timeupdate', updateProgress);
    video.addEventListener('loadedmetadata', () => {
      totalTimeEl.textContent = formatTime(video.duration);
    });
    
    // Update UI when video pauses (e.g., when exiting fullscreen on mobile)
    video.addEventListener('pause', () => {
      playIcon.style.display = 'block';
      pauseIcon.style.display = 'none';
    });
    
    // Update UI when video plays
    video.addEventListener('play', () => {
      playIcon.style.display = 'none';
      pauseIcon.style.display = 'block';
    });
    
    progressContainer.addEventListener('click', seek);
    fullscreenBtn.addEventListener('click', toggleFullscreen);

    // Show controls on video end
    video.addEventListener('ended', () => {
      playIcon.style.display = 'block';
      pauseIcon.style.display = 'none';
      controls.classList.add('active');
    });

    // Hide controls after inactivity
    let controlsTimeout;
    player.addEventListener('mousemove', () => {
      controls.classList.add('active');
      clearTimeout(controlsTimeout);
      if (!video.paused) {
        controlsTimeout = setTimeout(() => {
          controls.classList.remove('active');
        }, 2000);
      }
    });

    player.addEventListener('mouseleave', () => {
      if (!video.paused) {
        controls.classList.remove('active');
      }
    });
  }
</script>
