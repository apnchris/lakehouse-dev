---
import type { InferGetStaticParamsType } from "astro";
import Layout from '../../layouts/Layout.astro';
import { sanityClient } from "sanity:client";
import groq from "groq";
import { urlFor } from '../../utils/image';

export async function getStaticPaths() {
  const members = await sanityClient.fetch(
    groq`*[_type == "member"]{
      slug
    }`
  );
  
  return members.map((member: any) => ({
    params: { slug: member.slug.current },
  }));
}

type Params = InferGetStaticParamsType<typeof getStaticPaths>;
const { slug } = Astro.params as Params;

const member = await sanityClient.fetch(
  groq`*[_type == "member" && slug.current == $slug][0]{
    _id,
    name,
    slug,
    position,
    background,
    focus,
    mainImage,
    investmentCompanies[]->{
      _id,
      name,
      slug,
      logo
    }
  }`,
  { slug }
);
---

<Layout title={member.name} pageSlug="member">
  <section class="member-page regular-grid">
    <div class="member-name-position">
      <h1>{member.name}</h1>
      {member.position && (
        <p class="position sans uppercase">{member.position}</p>
      )}
    </div>

    {member.mainImage && (
      <div class="member-image">
        <img 
          src={urlFor(member.mainImage).width(800).height(800).url()} 
          alt={member.mainImage.alt || member.name}
        />
      </div>
    )}

    <div class="member-infos">
      <div class="member-section member-background-focus top-border">
        <div class="background-focus-triggers">
          {member.background && (
            <button data-target="background-section" class="member-content-trigger sans uppercase">
              Background{member.focus && (',')}
            </button>
          )}
          {member.focus && (
            <button data-target="focus-section" class="member-content-trigger sans uppercase">
              Focus
            </button>
          )}
        </div>
  
        <div class="background-focus-content">
          {member.background && (
            <div id="background-section" class="content-section">
              <p>{member.background}</p>
            </div>
          )}
          {member.focus && (
            <div id="focus-section" class="content-section">
              <p>{member.focus}</p>
            </div>
          )}
        </div>
      </div>

      {member.investmentCompanies && member.investmentCompanies.length > 0 && (
        <div class="member-section">
          <h2>Investment Companies</h2>
          <div class="companies-grid">
            {member.investmentCompanies.map((company: any) => (
              <a href={`/portfolio/${company.slug.current}`} class="company-card top-border">
                <h3>{company.name}</h3>
              </a>
            ))}
          </div>
        </div>
      )}
    </div>
    
  </section>
</Layout>

<style>
  .member-page {
    padding: 100px var(--gap) 200px;
  }

  .member-background-focus {
    display: flex;
    flex-direction: column;
    gap: var(--gap);
    padding-top: 8px;
  }

  .member-content-trigger:not(.active) {
    opacity: .5;
  }

  .background-focus-triggers {
    display: flex;
    gap: 0;
  }

  .member-content-trigger {
    padding-left: 4px;
    padding-right: 4px;
    transition: opacity .2s ease;
  }

  .member-name-position {
    position: fixed;
    top: var(--gap);
    left: calc((var(--column) * 1) + (var(--gap) * 2));
    display: flex;
    gap: 8px;
  }

  .member-image {
    height: calc(100dvh - 116px);
    grid-column: span 8;
  }

  .member-image img {
    height: 100%;
    width: calc((var(--column) * 4) + (var(--gap) * 3));
    margin-left: calc((var(--column) * 1) + (var(--gap) * 1));
    object-fit: cover;
  }
  
  .member-infos {
    grid-column: span 4;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    gap: 32px;
  }

  .content-section {
    display: none;
  }

  .content-section.active {
    display: block;
  }

  .companies-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    row-gap: 8px;
    margin-top: var(--gap);
  }

  .company-card {
    padding-top: 8px;
  }
</style>

<script>
  const triggers = document.querySelectorAll('.background-focus-triggers button');
  
  triggers.forEach(trigger => {
    trigger.addEventListener('click', () => {
      const targetId = trigger.getAttribute('data-target');
      const targetSection = document.getElementById(targetId);
      
      // Remove active class from all triggers and hide all sections
      triggers.forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Add active class to clicked trigger and show target section
      trigger.classList.add('active');
      targetSection?.classList.add('active');
    });
  });

  // Activate first button by default
  if (triggers.length > 0) {
    triggers[0].click();
  }
</script>
