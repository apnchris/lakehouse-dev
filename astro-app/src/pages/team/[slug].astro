---
import type { InferGetStaticParamsType } from "astro";
import Layout from '../../layouts/Layout.astro';
import { sanityClient } from "sanity:client";
import groq from "groq";
import { urlFor } from '../../utils/image';

export async function getStaticPaths() {
  const members = await sanityClient.fetch(
    groq`*[_type == "member"]{
      slug
    }`
  );
  
  return members.map((member: any) => ({
    params: { slug: member.slug.current },
  }));
}

type Params = InferGetStaticParamsType<typeof getStaticPaths>;
const { slug } = Astro.params as Params;

const member = await sanityClient.fetch(
  groq`*[_type == "member" && slug.current == $slug][0]{
    _id,
    name,
    slug,
    position,
    background,
    focus,
    mainImage,
    investmentCompanies[]->{
      _id,
      name,
      slug,
      logo
    }
  }`,
  { slug }
);
---

<Layout title={member.name} pageSlug="member">
  <section class="member-page regular-grid">
    <div class="member-name-position">
      <h1>{member.name}</h1>
      {member.position && (
        <p class="position sans uppercase">{member.position}</p>
      )}
    </div>

    {member.mainImage && (
      <div class="member-image">
        <img 
          src={urlFor(member.mainImage).width(800).height(800).url()} 
          alt={member.mainImage.alt || member.name}
        />
      </div>
    )}

    <div class="member-infos">
      <div class="member-section member-background-focus top-border">
        <div class="background-focus-triggers">
          {member.background && (
            <button data-target="background-section" class="member-content-trigger back-hover sans uppercase">
              Background{member.focus && (',')}
            </button>
          )}
          {member.focus && (
            <button data-target="focus-section" class="member-content-trigger back-hover sans uppercase">
              Focus
            </button>
          )}
        </div>
  
        <div class="background-focus-content">
          {member.background && (
            <div id="background-section" class="content-section">
              <p>{member.background}</p>
            </div>
          )}
          {member.focus && (
            <div id="focus-section" class="content-section">
              <p>{member.focus}</p>
            </div>
          )}
        </div>
      </div>

      {member.investmentCompanies && member.investmentCompanies.length > 0 && (
        <div class="member-section">
          <h2>Investment Companies</h2>
          <div class="companies-grid">
            {member.investmentCompanies.map((company: any) => (
              <a href={`/portfolio/${company.slug.current}`} class="company-card top-border">
                <h3>{company.name}</h3>
              </a>
            ))}
          </div>
        </div>
      )}
    </div>
    
  </section>
</Layout>

<style>
  .member-page {
    padding: 100px var(--gap) 200px;
  }

  .member-background-focus {
    display: flex;
    flex-direction: column;
    gap: var(--gap);
    padding-top: 8px;
  }

  .member-content-trigger:not(.active) {
    opacity: .5;
  }

  .background-focus-triggers {
    display: flex;
    gap: 0;
  }

  .member-content-trigger {
    padding-left: 4px;
    padding-right: 4px;
    transition: opacity .2s ease;
  }

  .member-name-position {
    position: fixed;
    top: var(--gap);
    left: calc((var(--column) * 1) + (var(--gap) * 2));
    display: flex;
    gap: 8px;
  }

  .member-image {
    height: calc(100dvh - 116px);
    grid-column: span 8;
  }

  .member-image img {
    height: 100%;
    width: calc((var(--column) * 5) + (var(--gap) * 4));
    margin-left: calc((var(--column) * 1) + (var(--gap) * 1));
    object-fit: cover;
  }
  
  .member-infos {
    grid-column: span 4;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    gap: 32px;
  }

  .content-section {
    display: none;
  }

  .content-section.active {
    display: block;
  }

  .companies-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    row-gap: 8px;
    margin-top: var(--gap);
  }

  .company-card {
    padding-top: 8px;
  }

  @media screen and (max-width: 820px) {
    .member-page {
      padding-top: 63px;
      padding-bottom: 100px;
      grid-template-columns: 1fr;
      row-gap: 36px;
    }

    .member-image,
    .member-infos {
      grid-column: 1;
    }

    .member-infos {
      gap: 72px;
    }

    .member-image {
      width: calc(100vw - (var(--gap) * 2));
      height: calc(100vw - (var(--gap) * 2));
    }

    .member-image img {
      width: 100%;
      margin-left: 0;
    }

    .member-background-focus {
      row-gap: 31px;
    }

    .member-name-position {
      position: relative;
      flex-direction: column;
      gap: 6px;
      left: auto;
      top: auto;
    }

    .background-focus-triggers {
      gap: 3px;
    }

    .member-content-trigger {
      padding-left: 0;
      padding-right: 0;
    }
  }
</style>

<script>
  function initializeMemberPage() {
    const triggers = document.querySelectorAll<HTMLButtonElement>('.background-focus-triggers button');
    
    triggers.forEach((trigger: HTMLButtonElement) => {
      trigger.addEventListener('click', () => {
        const targetId = trigger.getAttribute('data-target');
        
        // Guard against null targetId
        if (!targetId) return;
        
        const targetSection = document.getElementById(targetId);
        
        // Remove active class from all triggers and hide all sections
        triggers.forEach((t: HTMLButtonElement) => t.classList.remove('active'));
        document.querySelectorAll<HTMLElement>('.content-section').forEach((section: HTMLElement) => {
          section.classList.remove('active');
        });
        
        // Add active class to clicked trigger and show target section
        trigger.classList.add('active');
        if (targetSection) {
          targetSection.classList.add('active');
        }
      });
    });

    // Activate first button by default
    if (triggers.length > 0) {
      const firstTrigger = triggers[0];
      if (firstTrigger) {
        firstTrigger.click();
      }
    }
  }

  // Initialize based on document state
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeMemberPage);
  } else {
    // DOM is already ready
    initializeMemberPage();
  }
  
  // Handle Astro page transitions
  document.addEventListener('astro:page-load', initializeMemberPage);
</script>
