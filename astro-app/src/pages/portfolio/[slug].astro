---
import type { InferGetStaticParamsType } from "astro";
import Layout from '../../layouts/Layout.astro';
import { sanityClient } from "sanity:client";
import groq from "groq";
import { urlFor } from '../../utils/image';
import TextProfiles from '../../components/TextProfiles.astro';
import TextImage from '../../components/TextImage.astro';
import RelatedCompanies from '../../components/RelatedCompanies.astro';
import FullscreenImage from '../../components/FullscreenImage.astro';
import VideoPlayer from '../../components/VideoPlayer.astro';

const portfolioRaw = await sanityClient.fetch(
  groq`*[_type == "portfolio"][0]{
    portfolioText,
    defaultSort,
    companies[]->{
      _id,
      name,
      slug,
      shortDescription,
      thumbnailImage,
      mainImage,
      investmentStage,
      investmentDate,
      location
    }
  }`
);

function sortCompanies(companies: any[], sortType: string) {
  if (!companies?.length) return companies;
  const sorted = [...companies];
  if (sortType === 'az') {
    sorted.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
  } else if (sortType === 'oldest') {
    sorted.sort((a, b) => (new Date(a.investmentDate || 0)).getTime() - (new Date(b.investmentDate || 0)).getTime());
  } else if (sortType === 'newest') {
    sorted.sort((a, b) => (new Date(b.investmentDate || 0)).getTime() - (new Date(a.investmentDate || 0)).getTime());
  }
  return sorted;
}

const defaultSort = portfolioRaw?.defaultSort || 'az';
const portfolio = {
  ...portfolioRaw,
  companies: sortCompanies(portfolioRaw?.companies || [], defaultSort),
};

function formatDate(dateString: string) {
  if (!dateString) return null;
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
}

function formatShortDate(dateString: string) {
  if (!dateString) return null;
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
}

const companyCount = portfolio?.companies?.length || 0;
const formattedCount = companyCount.toString().padStart(2, '0');

export async function getStaticPaths() {
  const companies = await sanityClient.fetch(
    groq`*[_type == "company"]{
      slug
    }`
  );
  
  return companies.map((company: any) => ({
    params: { slug: company.slug.current },
  }));
}

type Params = InferGetStaticParamsType<typeof getStaticPaths>;
const { slug } = Astro.params as Params;

const company = await sanityClient.fetch(
  groq`*[_type == "company" && slug.current == $slug][0]{
    _id,
    name,
    slug,
    description,
    shortDescription,
    thumbnailImage,
    mainImage,
    backgroundColor,
    investmentStage,
    investmentDate,
    location,
    founders,
    socialMedia[]{
      _key,
      text,
      url
    },
    content[]{
      _type,
      _key,
      _type == "textProfiles" => {
        text,
        profiles[]{
          _key,
          name,
          position,
          background,
          mainImage,
          member->{
            _id,
            name,
            slug
          }
        }
      },
      _type == "textImage" => {
        text,
        mainImage{
          ...,
          alt,
          caption
        }
      },
      _type == "relatedCompanies" => {
        relatedCompanies[]->{
          _id,
          name,
          slug,
          thumbnailImage,
          mainImage,
          investmentStage
        }
      },
      _type == "fullscreenImage" => {
        mainImage{
          ...,
          alt,
          caption
        }
      },
      _type == "videoPlayer" => {
        videoPoster,
        videoFile{
          asset->{
            url
          }
        },
        videoCdn
      }
    },
    relatedCompanies[]->{
      _id,
      name,
      slug,
      thumbnailImage,
      mainImage
    }
  }`,
  { slug }
);
---

<Layout title={company.name} pageSlug="company" backgroundColor={company.backgroundColor}>
  <section class="company-page">
    <div class="company-main-content regular-grid">
      {company.mainImage && (
        <div class="company-main-image">
          <img 
            src={urlFor(company.mainImage).width(3000).height(2000).quality(100).fit('max').url()} 
            alt={company.mainImage.alt || company.name}
          />
        </div>
      )}

      <div class="company-infos">
        {company.description && (
          <div class="company-description">
            <h1>{company.name}</h1>
            <p>{company.description}</p>
          </div>
        )}

        <div class="company-details">
          {company.founders && company.founders.length > 0 && (
            <div class="detail-item top-border">
              <span class="detail-label sans uppercase">Founders</span>
              <span class="detail-value">{company.founders.join(', ')}</span>
            </div>
          )}
          
          {company.investmentStage && (
            <div class="detail-item top-border">
              <span class="detail-label sans uppercase">Invested</span>
              <span class="detail-value">{company.investmentStage}{company.investmentDate && (", " + formatDate(company.investmentDate))}</span>
            </div>
          )}

          {company.location && (
            <div class="detail-item top-border">
              <span class="detail-label sans uppercase">Location</span>
              <span class="detail-value">{company.location}</span>
            </div>
          )}
          
          {company.socialMedia && company.socialMedia.length > 0 && (
            <div class="detail-item top-border">
              <span class="detail-label sans uppercase">Links</span>
              <span class="detail-value">
                {company.socialMedia.map((link: any, index: number) => (
                  <a href={link.url} target="_blank" rel="noopener noreferrer" class="social-link">
                    {link.text}{index < company.socialMedia.length - 1 && ', '}
                  </a>
                ))}
              </span>
            </div>
          )}
        </div>
      </div>
    </div>

    {company.content && company.content.length > 0 && (
      <div class="company-content">
        {company.content.map((block: any) => {
          if (block._type === 'textProfiles') {
            return <TextProfiles profiles={block.profiles} text={block.text} />;
          }
          if (block._type === 'textImage') {
            return <TextImage text={block.text} mainImage={block.mainImage} />;
          }
          if (block._type === 'relatedCompanies') {
            return <RelatedCompanies relatedCompanies={block.relatedCompanies} />;
          }
          if (block._type === 'fullscreenImage') {
            return <FullscreenImage mainImage={block.mainImage} />;
          }
          if (block._type === 'videoPlayer') {
            return <VideoPlayer videoPoster={block.videoPoster} videoFile={block.videoFile} videoCdn={block.videoCdn} />;
          }
          return null;
        })}
      </div>
    )}

    {portfolio?.companies && portfolio.companies.length > 0 && (      
      <div class="portfolio-list">
        <div class="portfolio-list-header regular-grid">
          <div class="portfolio-count sans">{formattedCount}</div>
          <div class="company-name-info">Companies</div>
          <div class="portfolio-sorts">
            <span class="portfolio-sort" data-sort="az" class:list={[defaultSort === 'az' && 'active']}>A-Z,</span>
            <span class="portfolio-sort" data-sort="oldest" class:list={[defaultSort === 'oldest' && 'active']}>Oldest,</span>
            <span class="portfolio-sort" data-sort="newest" class:list={[defaultSort === 'newest' && 'active']}>Newest</span>
          </div>
        </div>
      
        {portfolio.companies.map((company: any) => (
          <a href={`/portfolio/${company.slug.current}`} class="company-list-item top-border regular-grid" data-date={company.investmentDate || ''}>
            {company.investmentStage && (
              <span class="sans uppercase">
                {company.investmentStage}<span class="hide-desktop">, {formatShortDate(company.investmentDate)}</span>
              </span>
            )}

            <div class="company-name-info">
              <h2 class="company-name">{company.name}</h2>
              
              {company.shortDescription && (
                <span class="company-description">{company.shortDescription}</span>
              )}
            </div>

            {company.mainImage && (
              <div class="company-image">
                <img 
                  src={urlFor(company.thumbnailImage).width(1200).height(1200).quality(100).fit('max').url()} 
                  alt={company.thumbnailImage.alt || company.name}
                />
              </div>
            )}

            {company.investmentDate && (
              <div class="company-date hide-mobile">
                {formatDate(company.investmentDate)}
              </div>
            )}
            
            {company.location && (
              <div class="company-location">
                {company.location}
              </div>
            )}
          </a>
        ))}
      </div>
    )}
  </section>
</Layout>

<style>
  .company-page {
    padding: 0 0 calc((var(--column) * 3) + (var(--gap) * 2));
  }

  .company-main-content {
    padding: 0 var(--gap);
  }

  .company-main-image {
    grid-column: span 8;
    margin-left: calc(var(--gap) * -1);
    line-height: 0;
  }

  .company-infos {
    grid-column: span 4;
    display: flex;
    flex-direction: column;
    gap: var(--gap);
    justify-content: space-between;
    padding: 100px 0 var(--gap);
  }

  .company-main-image img {
    width: 100%;
    height: 100dvh;
    object-fit: cover;
  }

  .company-main-content,
  .related-section {
    margin-bottom: 128px;
  }

  .company-name-info {
    display: flex;
    gap: 8px;
  }

  .detail-item {
    display: grid;
    gap: var(--gap);
    grid-template-columns: repeat(4, 1fr);
    padding: 8px 0;
  }

  .detail-item:last-child {
    padding-bottom: 0;
  }

  .detail-value {
    grid-column: span 3;
  }

  .company-infos h1 {
    margin-bottom: 16px;
  }

  @media screen and (max-width: 820px) {
    .company-main-content {
      grid-template-columns: 1fr;
      gap: 36px;
      margin-bottom: 72px;
    }

    .company-infos h1 {
      margin-bottom: 36px;
    }

    .company-main-image img {
      height: 50dvh;
    }

    .company-main-image {
      width: 100vw;
      margin-left: calc(var(--gap) * -1);
    }

    .company-page {
      padding-bottom: 100px;
      grid-template-columns: 1fr;
      row-gap: 36px;
    }

    .company-main-image,
    .company-infos {
      grid-column: 1;
    }

    .company-infos {
      padding-top: 0;
      padding-bottom: 0;
      width: calc(100vw - (var(--gap) * 2));
      gap: 72px;
    }    

    .detail-label,
    .detail-value {
      grid-column: span 2;
    }
  }
</style>

<script>
  function initializePortfolio() {
    // Sorting functionality
    const sorts = document.querySelectorAll<HTMLElement>('.portfolio-sort');
    const listContainer = document.querySelector<HTMLElement>('.portfolio-list');
    
    if (sorts.length === 0 || !listContainer) return;
    
    // Remove existing event listeners by cloning elements
    sorts.forEach((sort: HTMLElement) => {
      const newSort = sort.cloneNode(true) as HTMLElement;
      sort.parentNode?.replaceChild(newSort, sort);
    });
    
    // Get fresh references after cloning
    const freshSorts = document.querySelectorAll<HTMLElement>('.portfolio-sort');
    
    freshSorts.forEach((sort: HTMLElement) => {
      sort.addEventListener('click', () => {
        const sortType = sort.getAttribute('data-sort');
        
        // Get fresh company items on each sort
        const companyItems = Array.from(document.querySelectorAll<HTMLElement>('.company-list-item'));
        
        const companiesData = companyItems.map((item: HTMLElement) => {
          const name = item.querySelector('.company-name')?.textContent?.trim() || '';
          const dateStr = item.getAttribute('data-date') || '';
          return {
            element: item,
            name: name,
            date: dateStr ? new Date(dateStr) : new Date(0)
          };
        });
        
        // Update active state
        freshSorts.forEach((s: HTMLElement) => s.classList.remove('active'));
        sort.classList.add('active');
        
        // Sort the data
        let sortedData = [...companiesData];
        
        if (sortType === 'az') {
          sortedData.sort((a, b) => a.name.localeCompare(b.name));
        } else if (sortType === 'oldest') {
          sortedData.sort((a, b) => a.date.getTime() - b.date.getTime());
        } else if (sortType === 'newest') {
          sortedData.sort((a, b) => b.date.getTime() - a.date.getTime());
        }
        
        // Reorder DOM elements
        const header = listContainer.querySelector<HTMLElement>('.portfolio-list-header');
        sortedData.forEach(data => {
          listContainer.appendChild(data.element);
        });
        
        // Keep header at the top
        if (header) {
          listContainer.insertBefore(header, listContainer.firstChild);
        }
      });
    });
    
    // Default sort is applied server-side; active class set via class:list
  }

  // Initialize based on document state
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializePortfolio);
  } else {
    // DOM is already ready
    initializePortfolio();
  }
  
  // Handle Astro page transitions
  document.addEventListener('astro:page-load', initializePortfolio);

  function initializeHeaderScroll() {
    const headerLogo = document.querySelector<HTMLElement>('.header-logo');
    const headerLinks = document.querySelector<HTMLElement>('.header-links');
    const windowThreshold = window.innerHeight; // 100dvh for window scroll
    const mainThreshold = window.innerHeight / 2; // 50dvh for main scroll
    const ww = window.innerWidth;

    function handleScroll(event?: Event) {
      let scrollPosition: number;
      let threshold: number;
      
      // Check if scroll came from main element
      if (ww < 821) {
        scrollPosition = window.scrollY;
        threshold = mainThreshold;
      } else {
        scrollPosition = window.scrollY;
        threshold = windowThreshold;
      }
      
      if (scrollPosition > threshold - 26) {
        headerLogo?.classList.add('black');
        headerLinks?.classList.add('black');
      } else {
        headerLogo?.classList.remove('black');
        headerLinks?.classList.remove('black');
      }
    }

    // Listen to both window and main element scroll
    window.addEventListener('scroll', handleScroll);
    
    handleScroll(); // Check initial state
  }

  // Initialize based on document state
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeHeaderScroll);
  } else {
    initializeHeaderScroll();
  }
  
  // Handle Astro page transitions
  document.addEventListener('astro:page-load', initializeHeaderScroll);
</script>
