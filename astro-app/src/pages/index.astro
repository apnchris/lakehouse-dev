---
import Layout from "../layouts/Layout.astro";
import { sanityClient } from "sanity:client";
import groq from "groq";
import { urlFor } from '../utils/image';

const homepage = await sanityClient.fetch(
  groq`*[_type == "homepage"][0]{
    aboutShort,
    aboutText,
    videoPoster,
    "videoFileUrl": videoFile.asset->url,
    videoCdn
  }`
);

const videoUrl = homepage?.videoCdn || homepage?.videoFileUrl || null;
const posterUrl = homepage?.videoPoster ? urlFor(homepage.videoPoster).width(1920).url() : null;
---

<Layout title="Lakehouse">
  <section class="homepage">
    <div class="hero-text">
      {homepage?.aboutShort && (
        <h1>Lakehouse</h1> <span>{homepage.aboutShort}</span>
      )}
      {homepage?.aboutText && (
        <span class="read-more-trigger back-hover sans uppercase">Read more</span>
        <span class="about-text">{homepage.aboutText}</span>
      )}
    </div>

    {videoUrl && (
      <div class="video-container">
        <video 
          autoplay 
          muted 
          loop 
          playsinline
          poster={posterUrl}
        >
          <source src={videoUrl} type="video/mp4" />
        </video>
      </div>
    )}
  </section>
</Layout>

<style>
  .hero-text {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 101;
    margin: var(--gap);
    width: calc( (var(--column) * 4) + (var(--gap) * 3) );
    pointer-events: none;
  }

  .hero-text h1 {
    display: inline-block;
    width: 77px;
    opacity: 0;
    text-align: center;
  }

  .about-text {
    opacity: 0;
    pointer-events: none;
    transition: opacity .2s ease;
  }

  .hero-text.show .about-text {
    opacity: 1;
    pointer-events: auto;
  }

  .read-more-trigger {
    position: absolute;
    /* transform: translateY(-4px); */
    cursor: pointer;
    transition: opacity .2s ease;
    pointer-events: auto;
    white-space: nowrap;
    margin-left: 4px;
  }

  .hero-text.show .read-more-trigger {
    opacity: 0;
  }

  .video-container {
    position: fixed;
    width: 100vw;
    height: 100dvh;
    top: 0;
    left: 0;
    z-index: 5;
  }

  .video-container video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  @media screen and (max-width: 820px) {
    .hero-text {
      width: calc(100vw - (var(--gap) * 2));
      margin-top: 10px;
    }

    .hero-text h1 {
      width: 58.5px;
    }
  }
</style>

<script>
  function initializeHomepage() {
    const trigger = document.querySelector<HTMLElement>('.read-more-trigger');
    const heroText = document.querySelector<HTMLElement>('.hero-text');
    const video = document.querySelector<HTMLVideoElement>('.video-container video');
    
    // Initialize video autoplay
    if (video) {
      video.muted = true; // Ensure muted for autoplay
      video.play().catch(err => {
        console.log('Video autoplay failed:', err);
      });
    }
    
    // Initialize read more trigger
    if (!trigger || !heroText) return;
    
    // Remove existing event listener by cloning
    const newTrigger = trigger.cloneNode(true) as HTMLElement;
    trigger.parentNode?.replaceChild(newTrigger, trigger);
    
    // Add event listener to the new element
    newTrigger.addEventListener('click', () => {
      heroText.classList.toggle('show');
    });
  }

  // Initialize based on document state
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeHomepage);
  } else {
    initializeHomepage();
  }
  
  // Handle Astro page transitions
  document.addEventListener('astro:page-load', initializeHomepage);
</script>
